<?php

namespace App\Http\Controllers\Clients;

use App\Models\User;
use App\Models\BienThe;
use App\Models\DonHang;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use App\Models\LichSuDonHang;
use App\Models\ChiTietDonHang;
use Illuminate\Support\Facades\DB;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
use App\Http\Requests\Client\UserRequest;
use App\Models\PhieuGiamGiaTaiKhoan;

class UserController extends Controller
{
    public function chiTiet()
    {
        $user = Auth::user();
        // dd($user);
        $donHangsPaginate = $user->donHangs()
            ->orderBy('id', 'desc')
            ->paginate(8);

        $i = 0;
        if ($user) {
            foreach ($donHangsPaginate as $item) {
                $i += ($item->trang_thai_don_hang == 0) ? 1 : 0;
            }
            return view('clients.users.chitiet', compact('user', 'i', 'donHangsPaginate'));
        } else {
            return redirect()->route('login.client');
        }
    }

    public function updateInfor(UserRequest $request, string $id)
    {
        $data = $request->all();
        $user = User::findOrFail($id);
        if ($request->hasFile('anh_dai_dien')) {
            if (Auth::user()->anh_dai_dien && file_exists(storage_path("app/public/" . Auth::user()->anh_dai_dien)) && !file_exists(storage_path("app/public/images"))) {
                unlink(storage_path('app/public/' . Auth::user()->anh_dai_dien));
            }
            $fileName = time() . '_' . $request->file('anh_dai_dien')->getClientOriginalName();
            $request->file('anh_dai_dien')->storeAs("public/uploads/user/", $fileName);
            $data['anh_dai_dien'] = 'uploads/user/' . $fileName;
        }
        $user->update($data);
        return redirect()->back()->with('success', 'C·∫≠p nh·∫≠t th√†nh c√¥ng');
    }

    public function orderTracking(string $id)
    {
        if (Auth::user()) {
            $donHang = DonHang::where('id', $id)->first();
            $lichSuDonHangs = LichSuDonHang::where('don_hang_id', '=', $id)->get();
            if ($donHang) {
                $checkVoucher = PhieuGiamGiaTaiKhoan::with('phieuGiamGia')->where('order_id', $donHang->id)->first();
                $bienThes = DonHang::where('id', $id)->with('bienThes')->first();
                $bienThesPaginated = $bienThes->bienThes()->paginate(5);

                // Debug d·ªØ li·ªáu
                // dd($bienThesPaginated);

                $bienThesList = $bienThesPaginated->map(fn($bienThe) => [
                    'bien_the_id' => $bienThe->id,
                    'anh_bien_the' => $bienThe->anh_bien_the,
                    'ten_bien_the' => $bienThe->sanPham->ten_san_pham . ' - ' . $bienThe->ten_bien_the,
                    'gia_ban' => $bienThe->gia_ban,
                    'so_luong' => $bienThe->pivot->so_luong,
                    'id_san_pham' => $bienThe->san_pham_id,
                ]);
                // dd($bienThesList);
                return view('clients.users.ordertracking', compact('donHang', 'lichSuDonHangs', 'bienThesList', 'bienThesPaginated', 'checkVoucher'));
            } else {
                abort(404);
            }
        } else {
            return redirect()->route('login.client');
        }
    }

    public function updateTrangThai(Request $request, string $id)
    {
        // T√¨m ƒë∆°n h√†ng
        $donHang = DonHang::find($id);

        if ($donHang) {
            // X√°c nh·∫≠n H·ªßy h√†ng
            if ($request->trang_thai == -1) {
                // Ki·ªÉm tra tr·∫°ng th√°i thanh to√°n v√† tr·∫°ng th√°i ƒë∆°n h√†ng
                if ($donHang->trang_thai_don_hang <= 1) { // ƒê∆°n h√†ng ch∆∞a giao (ch∆∞a ho√†n th√†nh)
                    // Tr∆∞·ªùng h·ª£p ch∆∞a thanh to√°n
                    if ($donHang->trang_thai_thanh_toan == 0) {
                        // H·ªßy ƒë∆°n h√†ng m√† kh√¥ng c·∫ßn ho√†n ti·ªÅn
                        $chiTietDonHangs = ChiTietDonHang::where('don_hang_id', $donHang->id)->get();
                        foreach ($chiTietDonHangs as $chiTiet) {
                            $bienThe = BienThe::find($chiTiet->bien_the_id);
                            if ($bienThe) {
                                $bienThe->increment('so_luong', $chiTiet->so_luong);
                            }
                        }

                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
                        $donHang->update([
                            "trang_thai_don_hang" => $request->trang_thai,
                            "ly_do" => $request->ly_do
                        ]);

                        $lichSuDonHang = [
                            'don_hang_id' => $donHang->id,
                            'trang_thai' => $request->trang_thai
                        ];

                        LichSuDonHang::create($lichSuDonHang);

                        return redirect()->back()->with('success', 'Hu·ª∑ ƒë∆°n h√†ng th√†nh c√¥ng');
                    }

                    // Tr∆∞·ªùng h·ª£p ƒë√£ thanh to√°n
                    if ($donHang->trang_thai_thanh_toan == 1) {
                        // L·∫•y v√≠ ng∆∞·ªùi d√πng
                        $nguoiDung = $donHang->nguoiDung;
                        $vi = $nguoiDung->vi ?? $nguoiDung->vi()->create(['so_du' => 0]);

                        // C·ªông l·∫°i ti·ªÅn v√†o v√≠ n·∫øu ƒë∆°n h√†ng ƒë√£ thanh to√°n
                        $vi->so_du += $donHang->tong_tien;
                        $vi->save();

                        // Ghi log giao d·ªãch ho√†n ti·ªÅn v·ªõi m√¥ t·∫£ ƒë·∫ßy ƒë·ªß
                        $soDuTruoc = $vi->so_du - $donHang->tong_tien; // v√¨ ƒë√£ c·ªông ti·ªÅn tr∆∞·ªõc ƒë√≥
                        $maGiaoDich = strtoupper(Str::random(10)); // V√≠ d·ª•: 9KJL0PX2QZ
                        $vi->giaodichs()->create([
                            'so_tien' => $donHang->tong_tien,
                            'ma_giao_dich' => $maGiaoDich,
                            'loai' => 'Ho√†n ti·ªÅn',
                            'trang_thai' => 1,
                            'mo_ta' => "‚Ü©Ô∏è Ho√†n ti·ªÅn do h·ªßy ƒë∆°n h√†ng {$donHang->ma_don_hang}\n üí∞ S·ªë d∆∞: "
                                . number_format($soDuTruoc, 0, ',', '.')
                                . " ‚ûù "
                                . number_format($vi->so_du, 0, ',', '.')
                                . " VNƒê",
                        ]);

                        // Ho√†n l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong kho
                        $chiTietDonHangs = ChiTietDonHang::where('don_hang_id', $donHang->id)->get();
                        foreach ($chiTietDonHangs as $chiTiet) {
                            $bienThe = BienThe::find($chiTiet->bien_the_id);
                            if ($bienThe) {
                                $bienThe->increment('so_luong', $chiTiet->so_luong);
                            }
                        }

                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
                        $donHang->update([
                            "trang_thai_don_hang" => $request->trang_thai,
                            "ly_do" => $request->ly_do
                        ]);


                        // Ki·ªÉm tra s·ªë d∆∞ v√≠ sau khi ho√†n ti·ªÅn
                        $soDu = number_format($vi->so_du, 0, ',', '.');

                        // Th√¥ng b√°o cho ng∆∞·ªùi d√πng v·ªÅ s·ªë d∆∞ hi·ªán t·∫°i
                        return redirect()->back()->with('success', 'Hu·ª∑ ƒë∆°n h√†ng th√†nh c√¥ng. S·ªë d∆∞ v√≠ hi·ªán t·∫°i c·ªßa b·∫°n l√†: üí∞' . $soDu . ' VNƒê');
                    }
                } else {
                    return redirect()->back()->with('error', 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng khi tr·∫°ng th√°i kh√¥ng ph√π h·ª£p');
                }
            }

            // tr·∫£ h√†ng
            if ($request->trang_thai == 5) {
                if ($donHang->trang_thai_don_hang == 3) {
                    // Tr·∫£ h√†ng v√†o kho
                    $chiTietDonHangs = ChiTietDonHang::where('don_hang_id', $donHang->id)->get();
                    foreach ($chiTietDonHangs as $chiTiet) {
                        $bienThe = BienThe::find($chiTiet->bien_the_id);
                        if ($bienThe) {
                            $bienThe->increment('so_luong', $chiTiet->so_luong);
                        }
                    }

                    // N·∫øu ƒë√£ thanh to√°n, ho√†n ti·ªÅn v√†o v√≠ (ch·ªâ v·ªõi VNPAY ho·∫∑c V√≠)
                    if ($donHang->trang_thai_thanh_toan == 1 && in_array($donHang->phuong_thuc_thanh_toan_id, [2, 3])) {
                        $user = $donHang->nguoiDung;

                        // C·ªông ti·ªÅn v√†o v√≠
                        $user->vi->increment('so_du', $donHang->tong_tien);
                        $soDuMoi = $user->vi->so_du;

                        // Ghi l·ªãch s·ª≠ ho√†n ti·ªÅn
                        $soDuTruoc = $soDuMoi - $donHang->tong_tien;
                        $maGiaoDich = strtoupper(Str::random(10)); // V√≠ d·ª•: 9KJL0PX2QZ
                        DB::table('giaodichvis')->insert([
                            'vi_id' => $user->vi->id,
                            'ma_giao_dich' => $maGiaoDich,
                            'so_tien' => $donHang->tong_tien,
                            'loai' => 'Ho√†n ti·ªÅn',
                            'trang_thai' => 1,
                            'mo_ta' => "‚Ü©Ô∏è Ho√†n ti·ªÅn do tr·∫£ ƒë∆°n h√†ng {$donHang->ma_don_hang}\n üí∞ S·ªë d∆∞: "
                                . number_format($soDuTruoc, 0, ',', '.')
                                . " ‚ûù "
                                . number_format($soDuMoi, 0, ',', '.')
                                . " VNƒê",
                            'created_at' => now(),
                            'updated_at' => now(),
                        ]);

                        // G·ª≠i th√¥ng b√°o th√†nh c√¥ng v√† hi·ªÉn th·ªã s·ªë d∆∞
                        session()->flash('success', 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c tr·∫£ v√† ho√†n ti·ªÅn th√†nh c√¥ng. S·ªë d∆∞ v√≠ hi·ªán t·∫°i: ' . number_format($soDuMoi, 0, ',', '.') . ' VNƒê');
                    } else {
                        session()->flash('success', 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c tr·∫£ th√†nh c√¥ng.');
                    }


                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
                    $donHang->update([
                        "trang_thai_don_hang" => $request->trang_thai,
                        "trang_thai_thanh_toan" => 2,
                        "ly_do" => $request->ly_do,
                    ]);

                    $lichSuDonHang = [
                        'don_hang_id' => $donHang->id,
                        'trang_thai' => $request->trang_thai
                    ];

                    LichSuDonHang::create($lichSuDonHang);

                    return redirect()->back();
                }
            }


            // Tr·∫°ng th√°i ƒë∆°n h√†ng l√† "ƒë√£ giao" (tr·∫°ng th√°i = 4)
            if ($request->trang_thai == 4) {
                if ($donHang->trang_thai_don_hang == 3) {
                    $donHang->update([
                        "trang_thai_don_hang" => $request->trang_thai
                    ]);

                    $lichSuDonHang = [
                        'don_hang_id' => $donHang->id,
                        'trang_thai' => $request->trang_thai
                    ];

                    LichSuDonHang::create($lichSuDonHang);
                    return redirect()->back()->with('success', 'C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh c√¥ng');
                }
            }

            return redirect()->back()->with('error', 'C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th·∫•t b·∫°i');
        } else {
            abort(404);
        }
    }
}
